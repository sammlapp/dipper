name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ develop ]

jobs:
  lint-and-test:
    name: Lint and Test - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint frontend
        working-directory: frontend
        run: |
          echo "Running frontend linting..."
          # Add your linting commands here if you have them
          # npm run lint

      - name: Check Rust formatting
        working-directory: frontend/src-tauri
        run: cargo fmt -- --check

      - name: Clippy
        working-directory: frontend/src-tauri
        run: cargo clippy -- -D warnings

      - name: Build React app
        working-directory: frontend
        run: npm run build

      - name: Build Rust
        working-directory: frontend/src-tauri
        run: cargo build

      - name: Test PyInstaller build script
        run: |
          echo "✅ PyInstaller build script exists"
          test -f backend/build_pyinstaller.py

      - name: Test conda-pack build script
        run: |
          echo "✅ Conda-pack build script exists"
          test -f backend/build_conda_pack.py

  quick-build-test:
    name: Quick Build Test - PyInstaller
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test PyInstaller build
        run: |
          cd backend
          python build_pyinstaller.py

      - name: Verify executable
        run: |
          if [ -f "frontend/python-dist/lightweight_server" ]; then
            echo "✅ PyInstaller executable built successfully"
            ls -lh frontend/python-dist/lightweight_server
          else
            echo "❌ PyInstaller executable not found"
            exit 1
          fi
